<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta http-equiv="X-UA-Compatible" content="ie=edge">
   <title>My Awesome Website</title>
</head>

<style>
   
   :root {
      --perspective: 200px;
      --space-side-layers: 10%;
      --side-initial-move: 3%;
   }
   
   body {
      background: #efefef;
      margin: 0;
   }
   
   * {
      box-sizing: border-box;
   }
   
   main {
      height: 100vh;
      /* opacity: 0; */
      display: grid;
      place-items: center;
      overflow: hidden;
   }
   
   .scene {
      opacity: 0;
   }
   
   section {
      display: grid;
      /* width: 500px; */
      width: auto;
      /* height: 1000px; */
      /* max-width: 80%; */
      /* height: 100vh; */
      margin-inline: auto;
      /* border: 4px solid red;  */
      /* background: blue; */
      /* opacity: 0; */
      perspective: var(--perspective);
      transform-style: preserve-3d;
      scale: 0.90;
      cursor: pointer;
      justify-items: center;
   }
   
   section div {
      grid-area: 1 / 1 / -1 / -1;
      /* width: 100%; */
      height: 90vh;
      max-width: 80%;
      /* max-height: 100%; */
      background-clip: content-box;
      /* position: absolute; */
      box-sizing: border-box;
      /* opacity: 0.8; */
      background-color: transparent !important;
      margin: 0;
      /* scale: 0.94 ; */
      transform: translate3d(0, 0, -14px);
      user-select: none;
      align-content: center;
   }
   
   section div img {
      width: 100%;
      max-height: 100%;
      margin: 0;
      padding: 0;
      /* border: 2px solid blue; */
   }
   
   .mockup-5 {
      background-color: red;
      /* transform: translate3d(calc(var(--space-side-layers) * 4), 0, -40px); */
      /* transform: translate3d(0, 0, 0px); */
      /* translate: calc(var(--space-side-layers) * 4) 0; */
      
      /* scale: 0.8; */
   }
   
   .mockup-4 {
      background-color: blue;
      /* padding-right: calc(var(--space-side-layers) * 1); */
      /* transform: translate3d(0, 0, 0px); */
      /* translate: calc(var(--space-side-layers) * 3) 0; */
      
      /* scale: 0.85; */
   }
   
   .mockup-3 {
      background-color: green;
      /* padding-right: calc(var(--space-side-layers) * 2); */
      /* transform: translate3d(0, 0, 0px); */
      /* translate: calc(var(--space-side-layers) * 2) 0; */
      
      /* scale: 0.9; */
   }
   
   .mockup-2 {
      background-color: yellow;
      /* padding-right: calc(var(--space-side-layers) * 3); */
      /* padding-left: calc(var(--space-side-layers) * 2); */
      /* transform: translate3d(0, 0, 0px); */
      /* translate: calc(var(--space-side-layers) * 1) 0; */
      /* scale: 0.95; */
   }
   
   .mockup-1 {
      background-color: purple;
      /* padding-right: calc(var(--space-side-layers) * 4); */
      /* transform: translate3d(0, 0, 0px); */
      /* translate: calc(var(--space-side-layers) * 0) 0; */
      
   }
   
</style>

<body>
   <main>
      <div class="scene">
         <section>
            <div class="mockup-5"><img src="mobile-wallpaper-05.png"/></div>
            <div class="mockup-4"><img src="mobile-wallpaper-04.png"/></div>
            <div class="mockup-3"><img src="mobile-wallpaper-03.png"/></div>
            <div class="mockup-2"><img src="mobile-wallpaper-02.png"/></div>
            <div class="mockup-1"><img src="mobile-wallpaper-01.png"/></div>
         </section>
      </div>
   </main>
   
</body>

<script type="module">
import { CSSSpringEasing } from 'https://unpkg.com/spring-easing'

const supportsLinear = CSS.supports("transition-timing-function: linear(0, 0.25, 1)")

const springWithFallback = (springEasing) => {
   let [easing, duration] = CSSSpringEasing(springEasing)
   return supportsLinear ? { easing: `linear(${easing})`, duration } : { easing: 'ease', duration: duration / 2.5 }
}

const createSpring = (params) => springWithFallback({
   easing: `spring${params.type || ''}(${params.mass}, ${params.stiffness}, ${params.damping}, ${params.velocity})`,
   decimal: 5,
   quality: 1,
})

const springs = {
   multiplyMockups: createSpring({ mass: 5, stiffness: 300, damping: 40, velocity: 2 }),
   hideFrontMockup: createSpring({ type: '-in-out', mass: 5, stiffness: 300, damping: 40, velocity: 2 }),
   reveal: createSpring({ mass: 3, stiffness: 100, damping: 35, velocity: 1 }),
   bringToFront: createSpring({ mass: 3, stiffness: 250, damping: 40, velocity: 1 }),
}

const getCSSVariable = (name) => getComputedStyle(document.documentElement).getPropertyValue(name)

const mockupsElements = document.querySelectorAll('section > div')
const mockupsWrapper = document.querySelector('section')
const sceneWrapper = document.querySelector('.scene')
let currentMockupInViewIndex = mockupsElements.length - 1

const animateElement = (element, keyframes, options) => element.animate(keyframes, options)

const revealScene = () => {
   animateElement(mockupsWrapper, [{ scale: 1 }], {
      ...springs.reveal,
      fill: 'forwards',
      delay: 200
   })
   
   animateElement(sceneWrapper, [{ opacity: 1 }], {
      fill: 'forwards',
      easing: 'ease',
      duration: springs.reveal.duration / 4,
      delay: 200
   })
}

const calculateMockupPositions = () => {
   const positions = []
   const mockupsLength = mockupsElements.length
   for (let index = 0; index < mockupsLength; index++) {
      
      const translateX = `calc(${((mockupsLength - index - 1) * 5.8) ** 0.95} * var(--side-initial-move))`
      const translateZ = `-${((mockupsLength - index - 1) * 32) ** 1}px`
      const brightness = index === mockupsLength - 1 ? 1 : 0.6 + index * 0.03
      positions.push({ translateX, translateZ, translate3d: `translate3d(${translateX}, 0, ${translateZ})`, brightness })
   }
   return positions
}

const positionMockups = (positions) => {
   mockupsElements.forEach((mockup, index) => {
      
      const { translateX, translateZ, brightness } = positions[index]
      animateElement(mockup, [
      { transform: getComputedStyle(mockup).transform },
      { transform: `translate3d(${translateX}, 0, ${translateZ})`, filter: `brightness(${brightness})` }
      ], {
         ...springs.multiplyMockups,
         fill: 'forwards',
         delay: index * 90 + 700
      })
   })
}

const getWrappedIndex = (i, length) => ((i % length) + length) % length

const rotateMockups = () => {
   const n = mockupsElements.length
   mockupsElements.forEach((mockup, i) => {
      const nextIndex = getWrappedIndex(i - currentMockupInViewIndex, n)
      const { translate3d, brightness } = mockupPositions[nextIndex]
      
      if (i === currentMockupInViewIndex) {
         animateElement(mockup, [{ transform: 'translate3d(-10%, 0, 0px)' }], {
            fill: 'forwards',
            easing: 'ease-out',
            duration: 300,
         })
         animateElement(mockup, [{ opacity: 0 }], {
            fill: 'forwards',
            easing: 'ease',
            duration: 150,
            delay: 100
         })
         animateElement(mockup, [
         { transform: 'translate3d(80%, 0, -160px)', filter: 'brightness(0.5)', opacity: 0 },
         { transform: translate3d, filter: `brightness(${brightness})`, opacity: 1 }
         ], {
            ...springs.bringToFront,
            fill: 'forwards',
            delay: 300
         })
      } else {
         animateElement(mockup, [{ transform: translate3d, filter: `brightness(${brightness})` }], {
            ...springs.bringToFront,
            fill: 'forwards',
         })
      }
   })
   
   currentMockupInViewIndex = getWrappedIndex(currentMockupInViewIndex - 1, n)
};

const mockupPositions = calculateMockupPositions()
revealScene()
positionMockups(mockupPositions)
mockupsWrapper.addEventListener('click', rotateMockups)
</script>

</html>
